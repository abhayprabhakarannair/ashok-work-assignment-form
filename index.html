<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRO - Palakkad - Work Assignment Portal</title>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">

    <div x-data="workForm()" x-cloak class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg border border-slate-100 my-8">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-extrabold text-slate-800">SRO Palakkad</h2>
            <p class="text-sm text-slate-500 mt-2">Please complete all fields to submit.</p>
        </div>

        <div class="space-y-4 mb-8 p-5 bg-slate-50 rounded-xl border border-slate-200">
            <h4 class="text-xs font-bold uppercase tracking-widest text-slate-400 mb-4">Employee Information</h4>
            
            <div class="space-y-4">
                <div>
                    <input type="text" x-model="name" @blur="touched.name = true" placeholder="Full Name" 
                        :class="touched.name && name.length < 3 ? 'border-red-500' : 'border-slate-300'"
                        class="w-full p-3 rounded-lg border text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <p x-show="touched.name && name.length < 3" class="text-[10px] text-red-500 mt-1 ml-1 font-bold">Name must be at least 3 characters.</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <input type="text" x-model="empId" @blur="touched.empId = true" placeholder="Employee ID" 
                            :class="touched.empId && !empId ? 'border-red-500' : 'border-slate-300'"
                            class="w-full p-3 rounded-lg border text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <input type="email" x-model="email" @blur="touched.email = true" placeholder="Email Address" 
                            :class="touched.email && !validateEmail(email) ? 'border-red-500' : 'border-slate-300'"
                            class="w-full p-3 rounded-lg border text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <p x-show="touched.empId && !empId" class="text-[10px] text-red-500 font-bold ml-1">ID is required.</p>
                    <p x-show="touched.email && !validateEmail(email)" class="text-[10px] text-red-500 font-bold ml-1">Valid email required.</p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <input type="tel" x-model="mobile" @input="mobile = mobile.replace(/\D/g,'').slice(0,10)" @blur="touched.mobile = true" placeholder="10-Digit Mobile" 
                            :class="touched.mobile && mobile.length !== 10 ? 'border-red-500' : 'border-slate-300'"
                            class="w-full p-3 rounded-lg border text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <select x-model="trade" @blur="touched.trade = true" 
                            :class="touched.trade && !trade ? 'border-red-500' : 'border-slate-300'"
                            class="w-full p-3 rounded-lg border text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                            <option value="">-- Trade --</option>
                            <option value="SA">SA</option>
                            <option value="MTS">MTS</option>
                            <option value="MG">MG</option>
                            <option value="GDS">GDS</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <p x-show="touched.mobile && mobile.length !== 10" class="text-[10px] text-red-500 font-bold ml-1">Enter 10 digits.</p>
                    <p x-show="touched.trade && !trade" class="text-[10px] text-red-500 font-bold ml-1">Select a trade.</p>
                </div>
            </div>
        </div>

        <div class="space-y-4 mb-8">
            <h4 class="text-xs font-bold uppercase tracking-widest text-slate-400">2. Past 4 Years History</h4>
            <div class="grid grid-cols-2 gap-4">
                <template x-for="year in ['22', '23', '24', '25']" :key="year">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 mb-1" x-text="'YEAR 20' + year"></label>
                        <select x-model="years['y'+year]" @change="resetOptions()" class="w-full bg-white border border-slate-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">-- None --</option>
                            <template x-for="s in sections" :key="s">
                                <option :value="s" x-text="s"></option>
                            </template>
                        </select>
                    </div>
                </template>
            </div>
        </div>

        <div class="space-y-4 bg-blue-50/50 p-6 rounded-xl border border-blue-100">
            <h4 class="text-xs font-bold uppercase tracking-widest text-blue-400">3. Current Pending Assignments</h4>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-blue-700 mb-1">Option 1</label>
                    <select x-model="opt1" @change="opt2=''; opt3=''" class="w-full border border-blue-200 rounded-lg p-3 text-sm bg-white">
                        <option value="">-- Select --</option>
                        <template x-for="s in getPending()" :key="s">
                            <option :value="s" x-text="s"></option>
                        </template>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-blue-700 mb-1">Option 2</label>
                    <select x-model="opt2" :disabled="!opt1" @change="opt3=''" class="w-full border border-blue-200 rounded-lg p-3 text-sm bg-white disabled:opacity-40">
                        <option value="">-- Select --</option>
                        <template x-for="s in getPending().filter(i => i !== opt1)" :key="s">
                            <option :value="s" x-text="s"></option>
                        </template>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-blue-700 mb-1">Option 3</label>
                    <div x-show="getOpt3List().length === 1">
                        <input type="text" :value="autoFillOpt3()" readonly class="w-full border-2 border-emerald-500 bg-emerald-50 text-emerald-700 font-bold p-3 rounded-lg text-sm">
                    </div>
                    <div x-show="getOpt3List().length !== 1">
                        <select x-model="opt3" :disabled="!opt2" class="w-full border border-blue-200 rounded-lg p-3 text-sm bg-white disabled:opacity-40">
                            <option value="">-- Select --</option>
                            <template x-for="s in getOpt3List()" :key="s">
                                <option :value="s" x-text="s"></option>
                            </template>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="!canSubmit() && !isSubmitting" class="mt-6 p-3 bg-amber-50 rounded-lg border border-amber-200">
            <p class="text-[11px] text-amber-700 font-medium">
                <span class="font-bold">Missing:</span> 
                <span x-show="name.length < 3">Name, </span>
                <span x-show="!empId">Employee ID, </span>
                <span x-show="!validateEmail(email)">Valid Email, </span>
                <span x-show="mobile.length !== 10">10-digit Mobile, </span>
                <span x-show="!trade">Trade, </span>
                <span x-show="!opt3">Assignments (Opt 1-3)</span>
            </p>
        </div>

        <button 
            @click="submitData()" 
            :disabled="!canSubmit()"
            :class="!canSubmit() ? 'bg-slate-300 cursor-not-allowed' : 'bg-slate-900 hover:bg-slate-800 active:scale-95 shadow-lg shadow-slate-200'"
            class="w-full mt-4 text-white font-bold py-4 rounded-xl transition-all flex items-center justify-center space-x-2"
        >
            <span x-show="!isSubmitting">Submit Application</span>
            <span x-show="isSubmitting" class="flex items-center">
                <svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Processing...
            </span>
        </button>
    </div>

    <script>
        function workForm() {
            return {
                email: '', name: '', empId: '', mobile: '', trade: '',
                touched: { email: false, name: false, empId: false, mobile: false, trade: false },
                sections: ["TMO 1 (Day Set)", "TMO 2", "Parcel Hub 1 (Day Set)", "Parcel Hub 2", "Main office 1 (Day Set)", "Main Office 2", "ICH", "LR"],
                years: { y22: '', y23: '', y24: '', y25: '' },
                opt1: '', opt2: '', opt3: '',
                isSubmitting: false,
                scriptURL: '%%GOOGLE_SCRIPT_URL%%',

                validateEmail(email) {
                    return String(email).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);
                },
                canSubmit() {
                    return (
                        this.validateEmail(this.email) && 
                        this.name.length >= 3 && 
                        this.empId.length > 0 && 
                        this.mobile.length === 10 && 
                        this.trade !== '' && 
                        this.opt3 !== '' && 
                        !this.isSubmitting
                    );
                },
                getPending() {
                    let used = Object.values(this.years).filter(x => x !== '');
                    return this.sections.filter(s => !used.includes(s));
                },
                getOpt3List() {
                    return this.getPending().filter(i => i !== this.opt1 && i !== this.opt2);
                },
                autoFillOpt3() {
                    let list = this.getOpt3List();
                    if (list.length === 1) { this.opt3 = list[0]; return list[0]; }
                    return this.opt3;
                },
                resetOptions() { this.opt1 = ''; this.opt2 = ''; this.opt3 = ''; },

                async submitData() {
                    if (!this.canSubmit()) return;
                    this.isSubmitting = true;
                    try {
                        await fetch(this.scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                email: this.email, name: this.name, empId: this.empId, 
                                mobile: this.mobile, trade: this.trade,
                                ...this.years, o1: this.opt1, o2: this.opt2, o3: this.opt3
                            })
                        });
                        alert("Submitted successfully!");
                        location.reload(); 
                    } catch (e) {
                        alert("Error. Try again.");
                    } finally {
                        this.isSubmitting = false;
                    }
                }
            }
        }
    </script>
</body>
</html>